{% extends 'core/base.html' %}
{% load static %}

{% block title %}{% if object %}Editar{% else %}Novo{% endif %} Remédio - SantuarioVital{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center">
                <i class="fas fa-pills text-white text-2xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-white">
                    {% if object %}Editar Remédio{% else %}Novo Remédio{% endif %}
                </h1>
                <p class="text-purple-100 mt-1">Preencha os dados do remédio e seus ingredientes</p>
            </div>
        </div>
    </div>

    <!-- Formulário -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <form method="post" class="p-8">
            {% csrf_token %}
            
            <!-- Informações Básicas -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-purple-500 flex items-center gap-2">
                    <i class="fas fa-info-circle text-purple-600"></i>
                    Informações Básicas
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Nome <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="nome" value="{{ form.nome.value|default:'' }}"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                               placeholder="Ex: Poção Curativa, Elixir da Calma..."
                               required>
                        {% if form.nome.errors %}
                        <p class="text-red-600 text-sm mt-1 flex items-center gap-1">
                            <i class="fas fa-exclamation-circle"></i>
                            {{ form.nome.errors.0 }}
                        </p>
                        {% endif %}
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Descrição
                        </label>
                        <textarea name="descricao" rows="4"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition resize-none"
                                  placeholder="Descreva o remédio, sua função geral, características...">{{ form.descricao.value|default:'' }}</textarea>
                        <p class="text-gray-500 text-sm mt-1 flex items-center gap-1">
                            <i class="fas fa-lightbulb"></i>
                            Descrição geral do remédio
                        </p>
                    </div>
                </div>
            </div>

            <!-- Ingredientes -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-green-500 flex items-center gap-2">
                    <i class="fas fa-leaf text-green-600"></i>
                    Ingredientes e Quantidades
                </h2>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <p class="text-green-800 text-sm flex items-center gap-2">
                        <i class="fas fa-info-circle"></i>
                        <span>Adicione os ingredientes que compõem este remédio com suas respectivas quantidades</span>
                    </p>
                </div>
                
                <div id="ingredientes-container">
                    {{ ingredientes_formset.management_form }}
                    
                    <div class="space-y-3">
                        {% for form in ingredientes_formset %}
                        <div class="ingrediente-form grid grid-cols-12 gap-3 items-start p-3 bg-gray-50 rounded-lg border border-gray-200">
                            {{ form.id }}
                            
                            <div class="col-span-5">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Ingrediente</label>
                                <select name="{{ form.ingrediente.html_name }}" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
                                    <option value="">Selecione...</option>
                                    {% for ingrediente in form.ingrediente.field.queryset %}
                                    <option value="{{ ingrediente.pk }}" {% if form.ingrediente.value == ingrediente.pk|stringformat:"s" %}selected{% endif %}>
                                        {{ ingrediente.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-span-5">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Quantidade / Dose</label>
                                <input type="text" name="{{ form.quantidade.html_name }}" 
                                       value="{{ form.quantidade.value|default:'' }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                                       placeholder="Ex: 2 colheres, 100g, 5 gotas">
                            </div>
                            
                            <div class="col-span-2 flex items-end">
                                {% if form.instance.pk %}
                                <label class="flex items-center gap-2 text-sm text-red-600 cursor-pointer">
                                    {{ form.DELETE }}
                                    <i class="fas fa-trash"></i>
                                </label>
                                {% else %}
                                <button type="button" onclick="removeIngrediente(this)" 
                                        class="w-full px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <button type="button" onclick="addIngrediente()" 
                        class="mt-4 px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition text-sm font-medium flex items-center gap-2">
                    <i class="fas fa-plus"></i>
                    Adicionar Ingrediente
                </button>
            </div>

            <!-- Uso e Tratamento -->
            <div class="mb-8">
                <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500 flex items-center gap-2">
                    <i class="fas fa-hand-holding-medical text-blue-600"></i>
                    Uso e Tratamento
                </h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Modo de Uso
                        </label>
                        <textarea name="modo_uso" rows="5"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition resize-none"
                                  placeholder="Descreva como usar o remédio, posologia, frequência, duração do tratamento...">{{ form.modo_uso.value|default:'' }}</textarea>
                        <p class="text-gray-500 text-sm mt-1 flex items-center gap-1">
                            <i class="fas fa-clock"></i>
                            Instruções de como e quando usar
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Doenças Tratadas
                        </label>
                        <select name="doencas" multiple size="6"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            {% for doenca in form.doencas.field.queryset %}
                            <option value="{{ doenca.pk }}" {% if doenca.pk in form.doencas.value %}selected{% endif %}>
                                {{ doenca.nome }}
                            </option>
                            {% endfor %}
                        </select>
                        <p class="text-gray-500 text-sm mt-1 flex items-center gap-1">
                            <i class="fas fa-disease"></i>
                            Ctrl+clique para selecionar múltiplas doenças
                        </p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Observações
                        </label>
                        <textarea name="observacoes" rows="4"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition resize-none"
                                  placeholder="Observações adicionais, precauções, efeitos colaterais...">{{ form.observacoes.value|default:'' }}</textarea>
                        <p class="text-gray-500 text-sm mt-1 flex items-center gap-1">
                            <i class="fas fa-sticky-note"></i>
                            Informações adicionais importantes
                        </p>
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="flex gap-3 pt-6 border-t border-gray-200">
                <button type="submit" 
                        class="flex-1 md:flex-none px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all duration-200 font-semibold shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-save"></i>
                    <span>Salvar Remédio</span>
                </button>
                <a href="{% url 'remedio-list' %}" 
                   class="px-8 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200 font-semibold flex items-center justify-center gap-2">
                    <i class="fas fa-times"></i>
                    <span>Cancelar</span>
                </a>
            </div>
        </form>
    </div>
</div>

<script>
    let formCount = {{ ingredientes_formset.total_form_count }};
    
    function addIngrediente() {
        const container = document.getElementById('ingredientes-container').querySelector('.space-y-3');
        const emptyForm = container.querySelector('.ingrediente-form').cloneNode(true);
        
        // Atualizar índices do formulário
        const formRegex = /form-\d+-/g;
        emptyForm.innerHTML = emptyForm.innerHTML.replace(formRegex, `form-${formCount}-`);
        
        // Limpar valores
        emptyForm.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
        emptyForm.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
        emptyForm.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
        
        container.appendChild(emptyForm);
        
        // Atualizar total de forms
        formCount++;
        document.querySelector('#id_remedioingrediente_set-TOTAL_FORMS').value = formCount;
    }
    
    function removeIngrediente(button) {
        const form = button.closest('.ingrediente-form');
        form.remove();
        
        // Atualizar total de forms
        formCount--;
        document.querySelector('#id_remedioingrediente_set-TOTAL_FORMS').value = formCount;
    }
</script>
{% endblock %}
